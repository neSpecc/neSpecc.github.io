<script src="node_modules/graphon/dist/main.js"></script>
<script src="node_modules/hawk.javascript/dist/hawk.js"></script>
<script>
  new HawkCatcher({
    token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwcm9qZWN0SWQiOiI1ZDY3MGVmMzc3YzM3YTAwMTIxMTYyNjEiLCJpYXQiOjE1NjcwNDA5ODN9.NLR229AS0qhLLR8UrDKF97Kg2L2snVHAfEV-yfnCC68',
    collectorEndpoint: 'ws://localhost:3000/ws',
    release: 26141
  });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<style>
  body {
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 0;
    font-family: Roboto, 'Helvetica Neue', -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,sans-serif;
  }

  body.night-mode {
    background: #2b3037;
    color: #fff;
  }

  .graph {
    /*float: left;*/
  }

  .mode-toggler {
    text-align: center;
    padding: 20px;
    font-size: 17px;
    color: #108BE3;
    font-family: Roboto, 'Helvetica Neue', -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,sans-serif;
    cursor: pointer;
  }

  #log {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 15px;
    color: #eff7ff;
    background: #1f3144eb;
    font-size: 12px;
    font-family: Roboto;
    letter-spacing: 0.4px;
    box-shadow: 0 0 1px rgba(0,0,0,.2);
  }
</style>

<body>
<div id="graphs"></div>
</body>

<script>
  const wrapper = document.getElementById('graphs');
  const modeToggler = document.createElement('div');

  modeToggler.classList.add('mode-toggler');
  modeToggler.textContent = 'Switch to Night Mode';

  /**
   * Created Graphon instances will be stored here;
   */
  const instances = [];

  const sources = [
    {
      title: 'vc.ru',
      url: './data/vc.csv',
      urlByMonth: './data/vc-month.csv',
      // url: 'https://kmtt.ru/sheets/osnova_stats/vc',
      colors: ['#3497ED', '#F5BD25', '#f91d72'],
      labels: ['Регистрации', 'Статьи', 'Комментарии']
    },
    {
      title: 'TJ',
      // url: 'https://kmtt.ru/sheets/osnova_stats/tj',
      url: './data/tj.csv',
      urlByMonth: './data/tj-month.csv',
      colors: ['#3497ED', '#F5BD25', '#f91d72'],
      labels: ['Регистрации', 'Статьи', 'Комментарии']
    },
    {
      title: 'DTF',
      url: './data/dtf.csv',
      urlByMonth: './data/dtf-month.csv',
      // url: 'https://kmtt.ru/sheets/osnova_stats/dtf',
      colors: ['#3497ED', '#F5BD25', '#f91d72'],
      labels: ['Регистрации', 'Статьи', 'Комментарии']
    },
    {
      title: 'Платные функции по месяцам',
      url: './data/paid-all.csv',
      byMonth: true,
      // url: 'https://kmtt.ru/sheets/osnova_stats_month_paid/all',
      colors: ['#e25a76', '#db3053', '#af1e3c', 'rgb(51, 170, 221)', 'rgb(73, 154, 210)', 'rgb(240, 187, 19)', 'rgb(250, 216, 58)'],
      labels: ['Вакансии vc', 'Промо vc', 'Мероприятия vc', 'Вакансии dtf', 'Промо dtf', 'Промо TJ', 'Клуб TJ'],
      type: 'bar'
    },
  ];

  sources.forEach(async (source, idx) => {
    /**
     * Create a holder
     */
    const holder = document.createElement('div');
    const graphId = `telegraph-${idx}`;

    holder.id = graphId;
    holder.classList.add('graph');

    wrapper.appendChild(holder);

    if (idx === 0) {
      wrapper.appendChild(modeToggler);
    }

    const data = await fetch(source.url).then((response) => response.text());
    let dataByMonth = null;

    if (source.urlByMonth) {
      dataByMonth = await fetch(source.urlByMonth).then((response) => response.text());
    }

    const graph = new Graphon({
      title: source.title,
      holderId: graphId,
      data,
      dataByMonth,
      type: source.type || 'line',
      colors: source.colors,
      titles: source.labels,
      byMonth: source.byMonth
    });

    instances.push(graph);

  });

  /**
   * Handler for Toggle Night mode button
   */
  modeToggler.addEventListener('click', () => {
    instances.forEach( graph => {
      graph.toggleNightMode();
    });

    document.body.classList.toggle('night-mode');

    if (document.body.classList.contains('night-mode')){
      modeToggler.textContent = 'Switch to Day Mode';
    } else {
      modeToggler.textContent = 'Switch to Night Mode';
    }
  });
</script>